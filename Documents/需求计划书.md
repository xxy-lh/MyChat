
# Telegram 聊天系统 - 需求计划书 (架构修正版 v2.0)

## 1. 项目概述

### 1.1 项目背景

开发一个对标 Telegram 的高性能即时通讯系统，重点解决高并发下的消息实时性与数据一致性问题。

### 1.2 项目目标

- 构建**模块化单体 (Modulith)** 架构，支持从单机平滑过渡到微服务。
- 利用 **Java 21 虚拟线程** 实现单机百万级连接支持。
- 确保消息投递的可靠性（不丢消息）与低延迟（<100ms）。

### 1.3 技术约束

- **核心语言**: Java 21 (LTS)
- **框架基座**: Spring Boot 4.0.1 (Spring Framework 7)
- **构建工具**: Gradle (Kotlin DSL)

## 2. 核心功能需求

### 2.1 用户与认证 (Auth & User)

- **注册/登录**: 支持手机号/邮箱，采用 JWT + Refresh Token 双令牌机制。
- **安全**:  密码使用 BCrypt 强哈希存储，敏感操作需二次验证。
- **隐私**: 支持"最后上线时间"对不同人群可见性设置。

### 2.2 核心通讯 (Chat Core)

- **协议**: 自定义 STOMP 或纯 WebSocket 协议，通过 Redis Pub/Sub ���现集群消息路由。
- **单聊**: 支持文本、多媒体消息，支持 **2分钟内撤回**，支持**已读回执**。
- **消息ID**: **严禁使用自增ID**，全系统采用**雪花算法 (Snowflake)** 生成全局唯一且有序的 64位 ID。
- **离线消息**: 用户上线后通过拉模式（Pull）同步增量消息。

### 2.3 群组与频道 (Group & Channel)

- **群组**: 
  - 普通群（200人）：写扩散模型（每人存一份索引）。
  - 超级群（10w+人）：读扩散模型（只存一份消息，成员拉取）。
- **频道**:  纯广播模式，管理员发布，订阅者只读。

### 2.4 基础设施 (Infrastructure)

- **文件服务**: 集成 MinIO/OSS，支持图片自动缩略、视频第一帧截取。
- **推送系统**: 在线走 WebSocket，离线对接 FCM/APNs（预留接口）。

## 3. 技术选型 (已修正)

### 3.1 后端技术栈

| 技术组件               | 版本/选型                     | 用途          | 备注                           |
| :--------------------- | :---------------------------- | :------------ | :----------------------------- |
| **JDK**          | **21 (LTS)**            | 运行环境      | **强制使用虚拟线程特性** |
| **Framework**    | **Spring Boot 4.0.1**   | 核心框架      | 基于 Spring 7                  |
| **Architecture** | **Spring Modulith**     | 架构模式      | 模块化单体，边界清晰           |
| **ORM**          | **Spring Data JPA**     | 持久层        | 移除 MyBatis，统一标准         |
| **Database**     | MySQL 8.0+                    | 关系型库      | 存储核心业务数据               |
| **Cache/MQ**     | **Redis 7.x (Cluster)** | 缓存/消息总线 | 用于会话缓存、未读数、Pub/Sub  |
| **Security**     | Spring Security 6             | 安全认证      | OAuth2 Resource Server 模式    |
| **Build**        | **Gradle**              | 构建工具      | 依赖管理                       |

### 3.2 前端技术栈

| 技术       | 版本                   | 用途                              |
| : --------- | :--------------------- | : -------------------------------- |
| React      | 18+ (Hooks)            | 核心框架                          |
| Redux Toolkit | 2.x+                | 状态管理 (持久化存储)             |
| TypeScript | 5.x                    | 类型安全                          |
| IndexedDB  | idb                    | **本地消息存储 (离线优先)** |
| WebSocket  | Native / Stomp.js      | 实时通讯                          |

## 4. 数据库设计原则 (关键)

### 4.1 ID 生成策略

- **全站禁用数据库自增 ID**。
- 引入 **Snowflake (雪花算法)**：确保 ID 全局唯一且大致有序（便于索引排序）。
- 前端生成 `client_msg_id` (UUID) 用于消息去重。

### 4.2 读写分离与分表

- **冷热分离**: `message` 表只存近 3 个月数据，历史数据归档到 `message_history` 或列式存储。
- **未读数**:  **不存数据库字段**，完全依赖 Redis (`HINCRBY`)，仅在特定触发点异步持久化。

## 5. 项目阶段规划

- **Phase 1 (MVP)**: 跑通核心链路（登录 -> 建立WS连接 -> 互发文本消息 -> 消息落地）。
- **Phase 2 (Rich Media)**: 图片/文件上传，群聊功能（写扩散模式），Redis 消息路由。
- **Phase 3 (Optimization)**: 引入 Netty 优化网关，超级群（读扩散），端到端加密预研。